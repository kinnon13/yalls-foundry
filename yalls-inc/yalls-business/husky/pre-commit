#!/bin/bash
# Husky pre-commit hook for yalls-business
# Validates DTO schemas, runs ESLint, checks OPA policies

set -e

echo "ğŸ” [yalls-business] Running pre-commit checks..."

# 1. Validate TypeScript DTO schemas
echo "  â†’ Validating DTO schemas..."
npx tsc --noEmit --project yalls-inc/yalls-business/tsconfig.json || {
  echo "âŒ DTO validation failed"
  exit 1
}

# 2. Lint business code
echo "  â†’ Running ESLint..."
npx eslint yalls-inc/yalls-business/src --ext .ts,.tsx --max-warnings 0 || {
  echo "âŒ ESLint failed"
  exit 1
}

# 3. Check OPA policy syntax
echo "  â†’ Validating OPA policies..."
if command -v opa &> /dev/null; then
  opa check yalls-inc/yalls-business/sec/*.rego || {
    echo "âŒ OPA policy check failed"
    exit 1
  }
else
  echo "âš ï¸  OPA not installed, skipping policy check"
fi

# 4. Run unit tests for revenue-agg.ts
echo "  â†’ Running unit tests..."
npx vitest run yalls-inc/yalls-business/libs/utils/*.test.ts --reporter=dot || {
  echo "âŒ Unit tests failed"
  exit 1
}

echo "âœ… [yalls-business] Pre-commit checks passed"
