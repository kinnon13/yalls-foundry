#!/bin/bash
# Husky pre-commit hook for yalls-business
# Validates DTO schemas, runs ESLint, checks OPA policies

set -e

echo "🔍 [yalls-business] Running pre-commit checks..."

# 1. Validate TypeScript DTO schemas
echo "  → Validating DTO schemas..."
npx tsc --noEmit --project yalls-inc/yalls-business/tsconfig.json || {
  echo "❌ DTO validation failed"
  exit 1
}

# 2. Lint business code
echo "  → Running ESLint..."
npx eslint yalls-inc/yalls-business/src --ext .ts,.tsx --max-warnings 0 || {
  echo "❌ ESLint failed"
  exit 1
}

# 3. Check OPA policy syntax
echo "  → Validating OPA policies..."
if command -v opa &> /dev/null; then
  opa check yalls-inc/yalls-business/sec/*.rego || {
    echo "❌ OPA policy check failed"
    exit 1
  }
else
  echo "⚠️  OPA not installed, skipping policy check"
fi

# 4. Run unit tests for revenue-agg.ts
echo "  → Running unit tests..."
npx vitest run yalls-inc/yalls-business/libs/utils/*.test.ts --reporter=dot || {
  echo "❌ Unit tests failed"
  exit 1
}

echo "✅ [yalls-business] Pre-commit checks passed"
