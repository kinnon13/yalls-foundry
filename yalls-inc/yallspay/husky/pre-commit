#!/bin/sh
# Role: Pre-commit hook for Yallspay - validates payment logic
# Path: yalls-inc/yallspay/husky/pre-commit

echo "ğŸ” Yallspay Pre-commit: Validating payment logic..."

# Lint TypeScript
echo "ğŸ§¹ Linting TypeScript..."
npm run lint --workspace=yalls-inc/yallspay || exit 1

# Type check
echo "ğŸ”§ Type checking..."
npm run type-check --workspace=yalls-inc/yallspay || exit 1

# Validate commission splitter
echo "ğŸ’° Validating commission splitter..."
node -e "
const { splitCommission } = require('./yalls-inc/yallspay/libs/utils/commission-splitter.ts');
const result = splitCommission({
  transactionAmount: 100,
  userId: 'test',
  uplineChain: ['u1', 'u2', 'u3'],
});
if (result.total !== 100) {
  console.error(\`âŒ Commission split error: total \${result.total} !== 100\`);
  process.exit(1);
}
if (result.upline1 !== 10) {
  console.error(\`âŒ Upline1 split error: \${result.upline1} !== 10\`);
  process.exit(1);
}
console.log('âœ… Commission splitter valid');
" || exit 1

# Check for sensitive data (Stripe keys, etc.)
echo "ğŸ”’ Checking for sensitive data..."
if git diff --cached | grep -i 'sk_live'; then
  echo "âŒ ERROR: Stripe live key detected in commit!"
  echo "   Remove Stripe secret keys before committing."
  exit 1
fi

echo "âœ… Yallspay pre-commit passed!"
